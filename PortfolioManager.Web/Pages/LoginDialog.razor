@using MudBlazor
@using Microsoft.AspNetCore.Components
@using PortfolioManager.Contracts
@using PortfolioManager.Web.Services
@inject IBrokerageService BrokerageService
@inject IAuthStateService AuthStateService
@inject ISnackbar Snackbar
@inject IConfiguration Configuration

<MudDialog>
    <DialogContent>
        @if (_demoMode)
        {
            <MudAlert Severity="Severity.Info" Class="mb-3" Dense="true">
                <strong>Demo Mode:</strong> Use a valid email format (e.g., demo@example.com) and any password (6+ chars) to view sample portfolio data
            </MudAlert>
        }
        
        <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
            @if (!_requiresMfa)
            {
                <MudTextField @bind-Value="_email" 
                              Label="Email" 
                              Variant="Variant.Outlined" 
                              Class="mb-3"
                              OnKeyDown="HandleKeyDown"
                              Placeholder="@(_demoMode ? "demo@example.com" : "")"
                              Required="true"
                              RequiredError="Email is required"
                              Validation="@(new Func<string, string?>(ValidateEmail))"
                              Immediate="true" />
                <MudTextField @bind-Value="_password" 
                              Label="Password" 
                              Variant="Variant.Outlined" 
                              InputType="InputType.Password" 
                              Class="mb-3"
                              OnKeyDown="HandleKeyDown"
                              Placeholder="@(_demoMode ? "any password" : "")"
                              Required="true"
                              RequiredError="Password is required"
                              Validation="@(new Func<string, string?>(ValidatePassword))"
                              Immediate="true" />
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mb-3">
                    @if (_demoMode)
                    {
                        <strong>Demo Mode:</strong> <text>Enter a 6-digit MFA code to continue (e.g., 123456)</text>
                    }
                    else
                    {
                        <text>An MFA code has been sent to your email. Please enter it below.</text>
                    }
                </MudAlert>
                <MudTextField @bind-Value="_mfaCode" 
                              Label="MFA Code" 
                              Variant="Variant.Outlined" 
                              Class="mb-3"
                              OnKeyDown="HandleKeyDown"
                              Placeholder="@(_demoMode ? "123456" : "")"
                              Required="true"
                              RequiredError="MFA code is required"
                              Validation="@(new Func<string, string?>(ValidateMfaCode))"
                              Immediate="true"
                              MaxLength="6" />
            }
        </MudForm>

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3">@_errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="HandleLogin" 
                   Disabled="@(_isLoading || !_isFormValid)">
            @(_requiresMfa ? "Verify MFA" : "Login")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public EventCallback<string> OnLoginSuccess { get; set; }

    private MudForm? _form;
    private bool _isFormValid;
    private bool _demoMode;
    private string _email = "";
    private string _password = "";
    private string _mfaCode = "";
    private bool _requiresMfa = false;
    private bool _isLoading = false;
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        _demoMode = Configuration.GetValue<bool>("DemoMode");
    }

    private string? ValidateEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return "Email is required";
        
        if (!email.Contains("@"))
            return "Email must contain '@'";
        
        if (!email.Contains("."))
            return "Email must contain a domain";
        
        var parts = email.Split('@');
        if (parts.Length != 2)
            return "Invalid email format";
        
        if (string.IsNullOrWhiteSpace(parts[0]) || string.IsNullOrWhiteSpace(parts[1]))
            return "Invalid email format";
        
        if (email.Length < 3)
            return "Email is too short";
        
        return null;
    }

    private string? ValidatePassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return "Password is required";
        
        if (password.Length < 6)
            return "Password must be at least 6 characters";
        
        return null;
    }

    private string? ValidateMfaCode(string mfaCode)
    {
        if (string.IsNullOrWhiteSpace(mfaCode))
            return "MFA code is required";
        
        if (!mfaCode.All(char.IsDigit))
            return "MFA code must contain only digits";
        
        if (mfaCode.Length != 6)
            return "MFA code must be exactly 6 digits";
        
        return null;
    }

    private async Task HandleLogin()
    {
        try
        {
            if (_form == null)
                return;

            await _form.Validate();
            
            if (!_isFormValid)
                return;

            _isLoading = true;
            _errorMessage = null;

            if (!_requiresMfa)
            {
                var result = await BrokerageService.AuthenticateAsync(Constants.BrokerageSharesies, _email, _password);
                
                if (result.RequiresMfa)
                {
                    _requiresMfa = true;
                    _isFormValid = false;
                    Snackbar.Add("MFA code sent to your email", Severity.Info);
                }
                else if (result.Authenticated && !string.IsNullOrEmpty(result.UserId) && result.Tokens != null)
                {
                    await AuthStateService.SaveAuthStateAsync(Constants.BrokerageSharesies, result.UserId, result.Tokens);
                    Snackbar.Add("Login successful!", Severity.Success);
                    await OnLoginSuccess.InvokeAsync(result.UserId);
                    MudDialog.Close(DialogResult.Ok(result.UserId));
                }
                else
                {
                    _errorMessage = result.Message ?? "Login failed";
                }
            }
            else
            {
                var continuation = new AuthenticationContinuation
                {
                    Username = _email,
                    Password = _password,
                    MfaCode = _mfaCode
                };
                
                var result = await BrokerageService.ContinueAuthenticationAsync(Constants.BrokerageSharesies, continuation);
                
                if (result.Authenticated && !string.IsNullOrEmpty(result.UserId) && result.Tokens != null)
                {
                    await AuthStateService.SaveAuthStateAsync(Constants.BrokerageSharesies, result.UserId, result.Tokens);
                    Snackbar.Add("Login successful!", Severity.Success);
                    await OnLoginSuccess.InvokeAsync(result.UserId);
                    MudDialog.Close(DialogResult.Ok(result.UserId));
                }
                else
                {
                    _errorMessage = result.Message ?? "MFA verification failed";
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !_isLoading && _isFormValid)
        {
            await HandleLogin();
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
