@using MudBlazor
@using Microsoft.AspNetCore.Components
@using PortfolioManager.Contracts
@using PortfolioManager.Web.Services
@inject IBrokerageService BrokerageService
@inject IAuthStateService AuthStateService
@inject ISnackbar Snackbar
@inject IConfiguration Configuration

<MudDialog>
    <DialogContent>
        @if (_demoMode)
        {
            <MudAlert Severity="Severity.Info" Class="mb-3" Dense="true">
                <strong>Demo Mode:</strong> Enter any credentials to view sample portfolio data
            </MudAlert>
        }
        
        @if (!_requiresMfa)
        {
            <MudTextField @bind-Value="_email" 
                          Label="Email" 
                          Variant="Variant.Outlined" 
                          Class="mb-3"
                          OnKeyDown="HandleKeyDown"
                          Placeholder="@(_demoMode ? "demo@example.com" : "")" />
            <MudTextField @bind-Value="_password" 
                          Label="Password" 
                          Variant="Variant.Outlined" 
                          InputType="InputType.Password" 
                          Class="mb-3"
                          OnKeyDown="HandleKeyDown"
                          Placeholder="@(_demoMode ? "any password" : "")" />
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-3">
                An MFA code has been sent to your email. Please enter it below.
            </MudAlert>
            <MudTextField @bind-Value="_mfaCode" 
                          Label="MFA Code" 
                          Variant="Variant.Outlined" 
                          Class="mb-3"
                          OnKeyDown="HandleKeyDown" />
        }

        @if (_isLoading)
        {
            <MudProgressLinear Indeterminate="true" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3">@_errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="HandleLogin" Disabled="_isLoading">
            @(_requiresMfa ? "Verify MFA" : "Login")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public EventCallback<string> OnLoginSuccess { get; set; }

    private bool _demoMode;
    private string _email = "";
    private string _password = "";
    private string _mfaCode = "";
    private bool _requiresMfa = false;
    private bool _isLoading = false;
    private string? _errorMessage;

    protected override void OnInitialized()
    {
        _demoMode = Configuration.GetValue<bool>("DemoMode");
    }

    private async Task HandleLogin()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;

            if (!_requiresMfa)
            {
                var result = await BrokerageService.AuthenticateAsync(Constants.BrokerageSharesies, _email, _password);
                
                if (result.RequiresMfa)
                {
                    _requiresMfa = true;
                    Snackbar.Add("MFA code sent to your email", Severity.Info);
                }
                else if (result.Authenticated && !string.IsNullOrEmpty(result.UserId) && result.Tokens != null)
                {
                    await AuthStateService.SaveAuthStateAsync(Constants.BrokerageSharesies, result.UserId, result.Tokens);
                    Snackbar.Add("Login successful!", Severity.Success);
                    await OnLoginSuccess.InvokeAsync(result.UserId);
                    MudDialog.Close(DialogResult.Ok(result.UserId));
                }
                else
                {
                    _errorMessage = result.Message ?? "Login failed";
                }
            }
            else
            {
                var continuation = new AuthenticationContinuation
                {
                    Username = _email,
                    Password = _password,
                    MfaCode = _mfaCode
                };
                
                var result = await BrokerageService.ContinueAuthenticationAsync(Constants.BrokerageSharesies, continuation);
                
                if (result.Authenticated && !string.IsNullOrEmpty(result.UserId) && result.Tokens != null)
                {
                    await AuthStateService.SaveAuthStateAsync(Constants.BrokerageSharesies, result.UserId, result.Tokens);
                    Snackbar.Add("Login successful!", Severity.Success);
                    await OnLoginSuccess.InvokeAsync(result.UserId);
                    MudDialog.Close(DialogResult.Ok(result.UserId));
                }
                else
                {
                    _errorMessage = result.Message ?? "MFA verification failed";
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !_isLoading)
        {
            await HandleLogin();
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
