@page "/"

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

<button class="btn btn-primary" @onclick="StartIbkrQrLogin">Login with IBKR (QR)</button>

@if (!string.IsNullOrEmpty(QrImageBase64))
{
    <div>
        <p>Scan this QR code with your IBKR app:</p>
        <img src="@("data:image/png;base64," + QrImageBase64)" style="width:200px;height:200px;" />
    </div>
    <p>@(IsAuthenticated ? "Authenticated!" : "Waiting for approval...")</p>
}

@code {
    private string? QrImageBase64;
    private string? SessionId;
    private bool IsAuthenticated;

    private async Task StartIbkrQrLogin()
    {
        var http = new HttpClient { BaseAddress = new Uri(Navigation.BaseUri) };
        var resp = await http.PostAsJsonAsync("api/ibkr-qr-login/start", new { username = "your-username", password = "your-password" });
        var result = await resp.Content.ReadFromJsonAsync<IbkrQrStartResult>();
        QrImageBase64 = result?.qrImageBase64;
        SessionId = result?.sessionId;
        IsAuthenticated = false;
        if (SessionId != null)
        {
            _ = PollStatus();
        }
    }

    private async Task PollStatus()
    {
        var http = new HttpClient { BaseAddress = new Uri(Navigation.BaseUri) };
        while (!IsAuthenticated && !string.IsNullOrEmpty(SessionId))
        {
            await Task.Delay(2000);
            var resp = await http.GetAsync($"api/ibkr-qr-login/status/{SessionId}");
            if (resp.IsSuccessStatusCode)
            {
                var status = await resp.Content.ReadFromJsonAsync<IbkrQrStatusResult>();
                IsAuthenticated = status?.authenticated ?? false;
            }
        }
    }

    [Inject] NavigationManager Navigation { get; set; } = default!;
    private class IbkrQrStartResult { public string? sessionId { get; set; } public string? qrImageBase64 { get; set; } }
    private class IbkrQrStatusResult { public bool authenticated { get; set; } }
}

Welcome to your new app.
