@page "/"
@inject ISharesiesService SharesiesService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Dashboard</PageTitle>

<!-- Dashboard Header with Breadcrumb and Actions -->
<div class="d-flex justify-space-between align-center mb-6">
    <div>
        <MudText Typo="Typo.h4" Class="fw-bold mb-1">Portfolio Dashboard</MudText>
        <MudBreadcrumbs Items="_breadcrumbItems" Class="pa-0"></MudBreadcrumbs>
    </div>
    @if (!string.IsNullOrEmpty(GetPortfolioCurrency()))
    {
        <div class="d-flex align-center gap-3">
            <div class="currency-badge-lg">
                <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Small" Class="mr-1" />
                @GetPortfolioCurrency()
            </div>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Primary" Variant="Variant.Filled" OnClick="RefreshPortfolio" Class="rounded-lg" />
        </div>
    }
</div>

@if (!_isLoggedIn)
{
    <MudCard Elevation="2" Class="pa-4 mb-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">Connect Your Sharesies Account</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ShowLoginDialog">Login with Sharesies</MudButton>
        </MudCardContent>
    </MudCard>
}
else if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
    <MudText>Loading portfolio data...</MudText>
}
else if (_portfolioData != null)
{
    <MudGrid Spacing="4">
        <!-- Total Portfolio Value Card -->
        <MudItem xs="12" sm="6" lg="3">
            <MudCard Elevation="0" Class="ynex-stat-card">
                <MudCardContent Class="pa-5">
                    <div class="d-flex justify-space-between align-center mb-3">
                        <MudText Typo="Typo.body2" Class="text-muted fw-semibold text-uppercase">Total Portfolio Value</MudText>
                        <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="ynex-avatar-icon">
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Medium" />
                        </MudAvatar>
                    </div>
                    <MudText Typo="Typo.h4" Class="fw-bold mb-2">@GetTotalValue().ToString("C")</MudText>
                    <div class="d-flex align-center">
                        <span class="@(GetTotalReturn() >= 0 ? "ynex-badge-success" : "ynex-badge-error")" 
                              aria-label="@($"Return {(GetTotalReturn() >= 0 ? "gain" : "loss")} of {GetTotalReturn().ToString("C")}")">
                            @(GetTotalReturn() >= 0 ? "▲" : "▼") @(GetTotalReturn() >= 0 ? "+" : "")@GetTotalReturn().ToString("C")
                        </span>
                        <MudText Typo="Typo.caption" Class="text-muted ml-2">from invested</MudText>
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <!-- Total Return Card -->
        <MudItem xs="12" sm="6" lg="3">
            <MudCard Elevation="0" Class="ynex-stat-card">
                <MudCardContent Class="pa-5">
                    <div class="d-flex justify-space-between align-center mb-3">
                        <MudText Typo="Typo.body2" Class="text-muted fw-semibold text-uppercase">Total Return</MudText>
                        <MudAvatar Color="Color.Success" Size="Size.Medium" Class="ynex-avatar-icon">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Medium" />
                        </MudAvatar>
                    </div>
                    <MudText Typo="Typo.h4" Class="fw-bold mb-2">@GetTotalReturn().ToString("C")</MudText>
                    <div class="d-flex align-center">
                        <span class="@(GetReturnPercentage() >= 0 ? "ynex-badge-success" : "ynex-badge-error")"
                              aria-label="@($"Return percentage {(GetReturnPercentage() >= 0 ? "gain" : "loss")} of {Math.Abs(GetReturnPercentage()).ToString("F2")} percent")">
                            @(GetReturnPercentage() >= 0 ? "▲" : "▼") @(GetReturnPercentage() >= 0 ? "+" : "")@GetReturnPercentage().ToString("F2")%
                        </span>
                        <MudText Typo="Typo.caption" Class="text-muted ml-2">percentage gain</MudText>
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <!-- Total Holdings Card -->
        <MudItem xs="12" sm="6" lg="3">
            <MudCard Elevation="0" Class="ynex-stat-card">
                <MudCardContent Class="pa-5">
                    <div class="d-flex justify-space-between align-center mb-3">
                        <MudText Typo="Typo.body2" Class="text-muted fw-semibold text-uppercase">Total Holdings</MudText>
                        <MudAvatar Color="Color.Info" Size="Size.Medium" Class="ynex-avatar-icon">
                            <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Medium" />
                        </MudAvatar>
                    </div>
                    <MudText Typo="Typo.h4" Class="fw-bold mb-2">@GetHoldingsCount()</MudText>
                    <div class="d-flex align-center">
                        <MudText Typo="Typo.caption" Class="text-muted">Unique instruments</MudText>
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <!-- Cost Basis Card -->
        <MudItem xs="12" sm="6" lg="3">
            <MudCard Elevation="0" Class="ynex-stat-card">
                <MudCardContent Class="pa-5">
                    <div class="d-flex justify-space-between align-center mb-3">
                        <MudText Typo="Typo.body2" Class="text-muted fw-semibold text-uppercase">Cost Basis</MudText>
                        <MudAvatar Color="Color.Secondary" Size="Size.Medium" Class="ynex-avatar-icon">
                            <MudIcon Icon="@Icons.Material.Filled.Payments" Size="Size.Medium" />
                        </MudAvatar>
                    </div>
                    <MudText Typo="Typo.h4" Class="fw-bold mb-2">@GetTotalCostBasis().ToString("C")</MudText>
                    <div class="d-flex align-center">
                        <MudText Typo="Typo.caption" Class="text-muted">Total invested</MudText>
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Holdings Table -->
        <MudItem xs="12">
            <MudCard Elevation="0" Class="ynex-table-card">
                <MudCardHeader Class="pb-0">
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Class="fw-bold">Portfolio Holdings</MudText>
                        <MudText Typo="Typo.body2" Class="text-muted">Overview of your investment positions</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Default" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudTable Items="@GetHoldings()" Hover="true" Class="ynex-table" Elevation="0" Bordered="false">
                        <HeaderContent>
                            <MudTh Class="ynex-table-header">Symbol</MudTh>
                            <MudTh Class="ynex-table-header">Currency</MudTh>
                            <MudTh Class="ynex-table-header text-right">Shares</MudTh>
                            <MudTh Class="ynex-table-header text-right">Market Value</MudTh>
                            <MudTh Class="ynex-table-header text-right">Cost Basis</MudTh>
                            <MudTh Class="ynex-table-header text-right">Total Return</MudTh>
                            <MudTh Class="ynex-table-header text-right">Return %</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Symbol">
                                <div class="d-flex align-center">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-3" aria-label="@($"Symbol {context.Symbol}")">
                                        @GetSymbolAvatarText(context.Symbol)
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.body2" Class="fw-bold">@context.Symbol</MudText>
                                    </div>
                                </div>
                            </MudTd>
                            <MudTd DataLabel="Currency">
                                <span class="currency-chip">@context.Currency</span>
                            </MudTd>
                            <MudTd DataLabel="Shares" Class="text-right">
                                <MudText Typo="Typo.body2" Class="numeric-text">@context.SharesOwned.ToString("N2")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Market Value" Class="text-right">
                                <MudText Typo="Typo.body2" Class="fw-semibold numeric-text">@context.InvestmentValue.ToString("C")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Cost Basis" Class="text-right">
                                <MudText Typo="Typo.body2" Class="numeric-text">@context.CostBasis.ToString("C")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Total Return" Class="text-right">
                                <MudText Typo="Typo.body2" Color="@(context.TotalReturn >= 0 ? Color.Success : Color.Error)" Class="fw-semibold numeric-text"
                                         aria-label="@($"Total return {(context.TotalReturn >= 0 ? "gain" : "loss")} {context.TotalReturn.ToString("C")}")">
                                    @(context.TotalReturn >= 0 ? "+" : "")@context.TotalReturn.ToString("C")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Return %" Class="text-right">
                                <span class="@(context.ReturnPercentage >= 0 ? "ynex-return-badge-success" : "ynex-return-badge-error")"
                                      aria-label="@($"Return percentage {(context.ReturnPercentage >= 0 ? "gain" : "loss")} {Math.Abs(context.ReturnPercentage).ToString("F2")} percent")">
                                    @(context.ReturnPercentage >= 0 ? "▲" : "▼") @Math.Abs(context.ReturnPercentage).ToString("F2")%
                                </span>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
}

@code {
    private const string DefaultCurrency = "N/A";
    private const int MinSymbolAvatarLength = 1;
    private const int MaxSymbolAvatarLength = 2;
    
    private bool _isLoggedIn = false;
    private bool _isLoading = false;
    private string? _userId;
    private PortfolioResponse? _portfolioData;
    
    // Cached computed values
    private decimal _cachedTotalValue;
    private decimal _cachedTotalCostBasis;
    private decimal _cachedTotalReturn;
    private decimal _cachedReturnPercentage;
    private int _cachedHoldingsCount;
    
    private List<BreadcrumbItem> _breadcrumbItems = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Dashboard", href: null, disabled: true)
    };

    private async Task ShowLoginDialog()
    {
        var parameters = new DialogParameters
        {
            { "OnLoginSuccess", EventCallback.Factory.Create<string>(this, OnLoginSuccess) }
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<LoginDialog>("Login to Sharesies", parameters, options);
    }

    private async Task OnLoginSuccess(string userId)
    {
        _userId = userId;
        _isLoggedIn = true;
        await LoadPortfolioData();
        StateHasChanged();
    }

    private async Task LoadPortfolioData()
    {
        try
        {
            _isLoading = true;
            StateHasChanged();

            if (!string.IsNullOrEmpty(_userId))
            {
                _portfolioData = await SharesiesService.GetPortfolioAsync(_userId);
                ComputePortfolioMetrics();
            }

            _isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading portfolio: {ex.Message}", Severity.Error);
            _isLoading = false;
            StateHasChanged();
        }
    }
    
    private void ComputePortfolioMetrics()
    {
        if (_portfolioData?.Instruments == null)
        {
            _cachedTotalValue = 0;
            _cachedTotalCostBasis = 0;
            _cachedTotalReturn = 0;
            _cachedReturnPercentage = 0;
            _cachedHoldingsCount = 0;
            return;
        }

        _cachedTotalValue = 0;
        _cachedTotalCostBasis = 0;
        _cachedTotalReturn = 0;
        _cachedHoldingsCount = _portfolioData.Instruments.Count;

        foreach (var instrument in _portfolioData.Instruments)
        {
            _cachedTotalValue += instrument.InvestmentValue;
            _cachedTotalCostBasis += instrument.CostBasis;
            _cachedTotalReturn += instrument.TotalReturn;
        }

        _cachedReturnPercentage = _cachedTotalCostBasis > 0 
            ? (_cachedTotalReturn / _cachedTotalCostBasis * 100) 
            : 0;
    }

    private async Task RefreshPortfolio()
    {
        await LoadPortfolioData();
        Snackbar.Add("Portfolio refreshed", Severity.Success);
    }

    private decimal GetTotalValue()
    {
        return _cachedTotalValue;
    }

    private decimal GetTotalCostBasis()
    {
        return _cachedTotalCostBasis;
    }

    private decimal GetTotalReturn()
    {
        return _cachedTotalReturn;
    }

    private decimal GetReturnPercentage()
    {
        return _cachedReturnPercentage;
    }

    private int GetHoldingsCount()
    {
        return _cachedHoldingsCount;
    }

    private string GetPortfolioCurrency()
    {
        var firstInstrument = _portfolioData?.Instruments?.FirstOrDefault();
        return firstInstrument?.Currency ?? DefaultCurrency;
    }

    private List<HoldingViewModel> GetHoldings()
    {
        if (_portfolioData?.Instruments == null)
            return new List<HoldingViewModel>();

        return _portfolioData.Instruments
            .Select(instrument =>
            {
                var returnPercent = instrument.CostBasis > 0 
                    ? (instrument.TotalReturn / instrument.CostBasis * 100) 
                    : 0;

                return new HoldingViewModel
                {
                    Symbol = instrument.Symbol ?? "N/A",
                    Currency = instrument.Currency ?? DefaultCurrency,
                    SharesOwned = instrument.SharesOwned,
                    InvestmentValue = instrument.InvestmentValue,
                    CostBasis = instrument.CostBasis,
                    TotalReturn = instrument.TotalReturn,
                    ReturnPercentage = returnPercent
                };
            })
            .OrderByDescending(x => x.InvestmentValue)
            .ToList();
    }

    private string GetSymbolAvatarText(string symbol)
    {
        if (string.IsNullOrEmpty(symbol) || symbol.Length < MinSymbolAvatarLength)
            return "??";
        
        return symbol.Substring(0, Math.Min(MaxSymbolAvatarLength, symbol.Length));
    }

    public class HoldingViewModel
    {
        public string Symbol { get; set; } = "";
        public string Currency { get; set; } = "";
        public decimal SharesOwned { get; set; }
        public decimal InvestmentValue { get; set; }
        public decimal CostBasis { get; set; }
        public decimal TotalReturn { get; set; }
        public decimal ReturnPercentage { get; set; }
    }
}
