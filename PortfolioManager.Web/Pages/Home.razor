@page "/"
@using PortfolioManager.Contracts
@using PortfolioManager.Contracts.Web
@using PortfolioManager.Contracts.Models.Brokerage
@using PortfolioManager.Web.Components
@using AggregatedHoldingsTable = PortfolioManager.Web.Components.ViewModels.AggregatedHoldingsTable
@using DetailedHoldingsTable = PortfolioManager.Web.Components.ViewModels.DetailedHoldingsTable

<PageTitle>Dashboard</PageTitle>

<TimeAndMarketStatusCard 
    LocalTime="@_localTime"
    LocalTimeZone="@_localTimeZone"
    NyseTime="@_nyseTime"
    MarketStatus="@_marketStatus" />

<div class="d-none d-md-block">
    <DashboardHeader 
        Currency="@GetPortfolioCurrency()"
        OnRefresh="@RefreshPortfolio" />
</div>

<MudCard Elevation="2" Class="pa-4 mb-4">
    <MudCardContent>
        @if (_demoMode && !_isLoggedIn)
        {
            <MudAlert Severity="Severity.Success" Class="mb-3" Dense="true" Icon="@Icons.Material.Filled.Info">
                <strong>Demo Mode Active:</strong> This is a sample portfolio with demo data. Login with any credentials and MFA code to explore!
            </MudAlert>
        }
        <MudText Typo="Typo.h6" Class="mb-3">@(!_isLoggedIn && string.IsNullOrEmpty(_ibkrUsername) ? "Connect Your Brokerage Accounts" : "Brokerage Connections")</MudText>
        
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Filled" 
                      Class="@(_isLoggedIn ? "sharesies-login-btn-connected" : "sharesies-login-btn")" 
                      OnClick="ShowLoginDialog"
                      Disabled="@_isLoggedIn">
                <img src="images/sharesies-logo.png" alt="@Constants.BrokerageSharesies" class="mr-2" />
                @(_isLoggedIn ? "Connected to Sharesies" : "Connect to Sharesies")
            </MudButton>
            
            <MudButton Variant="Variant.Filled" 
                      Class="@(!string.IsNullOrEmpty(_ibkrUsername) ? "ibkr-login-btn-connected" : "ibkr-login-btn")"
                      OnClick="ShowIbkrLoginDialog"
                      Disabled="@(_demoMode || !string.IsNullOrEmpty(_ibkrUsername))">
                <img src="images/ibkr-logo.svg" alt="Interactive Brokers" class="mr-2" />
                @(!string.IsNullOrEmpty(_ibkrUsername) ? "Connected to IBKR" : "Connect to IBKR")
            </MudButton>
        </MudStack>
        
        @if (_demoMode && !_isLoggedIn)
        {
            <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
                Note: IBKR authentication is not available in demo mode
            </MudText>
        }
    </MudCardContent>
</MudCard>

@if (_isLoading)
{
    <MudProgressCircular Indeterminate="true" />
    <MudText>Loading portfolio data...</MudText>
}
else if (_portfolioData != null)
{
    <!-- Desktop Layout -->
    <div class="d-none d-md-block">
        <PortfolioStatsCards 
            TotalValue="@GetTotalValue()"
            DailyReturn="@GetDailyReturn()"
            DailyReturnPercentage="@GetDailyReturnPercentage()"
            HoldingsCount="@GetHoldingsCount()" />

        <MudItem xs="12" Class="mt-4">
            <MudCard Elevation="0" Class="port-dashboard-table-card">
                <MudCardHeader Class="pb-0">
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Class="fw-bold">Portfolio Holdings</MudText>
                        <MudText Typo="Typo.body2" Class="text-muted">Aggregated positions - click to view breakdown by brokerage</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.PieChart" Color="Color.Default" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudTable Items="@GetAggregatedHoldings()" 
                              Hover="true" 
                              Class="port-dashboard-table desktop-expandable-table" 
                              Elevation="0" 
                              Bordered="false"
                              SortLabel="Sort By"
                              AllowUnsorted="true"
                              Dense="false">
                        <HeaderContent>
                            <MudTh Class="port-dashboard-table-header" Style="width: 40px;"></MudTh>
                            <MudTh Class="port-dashboard-table-header"><MudTableSortLabel SortBy="new Func<AggregatedHoldingsTable.AggregatedHoldingViewModel, object>(x => x.Symbol)">Symbol</MudTableSortLabel></MudTh>
                            <MudTh Class="port-dashboard-table-header"><MudTableSortLabel SortBy="new Func<AggregatedHoldingsTable.AggregatedHoldingViewModel, object>(x => x.Currency)">Currency</MudTableSortLabel></MudTh>
                            <MudTh Class="port-dashboard-table-header text-right"><MudTableSortLabel SortBy="new Func<AggregatedHoldingsTable.AggregatedHoldingViewModel, object>(x => x.SharePrice)">Share Price</MudTableSortLabel></MudTh>
                            <MudTh Class="port-dashboard-table-header text-right"><MudTableSortLabel SortBy="new Func<AggregatedHoldingsTable.AggregatedHoldingViewModel, object>(x => x.TotalShares)">Total Shares</MudTableSortLabel></MudTh>
                            <MudTh Class="port-dashboard-table-header text-right"><MudTableSortLabel InitialDirection="SortDirection.Descending" SortBy="new Func<AggregatedHoldingsTable.AggregatedHoldingViewModel, object>(x => x.TotalValue)">Total Value</MudTableSortLabel></MudTh>
                            <MudTh Class="port-dashboard-table-header text-right"><MudTableSortLabel SortBy="new Func<AggregatedHoldingsTable.AggregatedHoldingViewModel, object>(x => x.TotalReturn)">Total Return</MudTableSortLabel></MudTh>
                            <MudTh Class="port-dashboard-table-header text-right"><MudTableSortLabel SortBy="new Func<AggregatedHoldingsTable.AggregatedHoldingViewModel, object>(x => x.AverageReturnPercentage)">Avg Return %</MudTableSortLabel></MudTh>
                            <MudTh Class="port-dashboard-table-header">Brokerages</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            @{
                                var isExpanded = _expandedDesktopHoldings.Contains(context.Symbol);
                                var rowClass = isExpanded ? "desktop-expandable-row expanded" : "desktop-expandable-row";
                            }
                            <MudTd DataLabel="" Class="expand-icon-cell" @onclick="@(() => ToggleDesktopHolding(context.Symbol))" style="cursor: pointer;" role="button" tabindex="0" aria-label="@($"Expand {context.Symbol} details")" @onkeydown="@((e) => HandleExpandKeyDown(e, context.Symbol))">
                                <MudIcon Icon="@(isExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" Size="Size.Small" Class="expand-icon" aria-hidden="true" />
                            </MudTd>
                            <MudTd DataLabel="Symbol" Class="@rowClass" @onclick="@(() => ToggleDesktopHolding(context.Symbol))" style="cursor: pointer;" role="button" tabindex="0" aria-expanded="@isExpanded" @onkeydown="@((e) => HandleExpandKeyDown(e, context.Symbol))">
                                <div class="d-flex align-center">
                                    <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-3" aria-label="@($"Symbol {context.Symbol}")">
                                        @GetSymbolAvatarText(context.Symbol)
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.body2" Class="fw-bold">@context.Symbol</MudText>
                                        <MudText Typo="Typo.caption" Class="text-muted">@context.Name</MudText>
                                    </div>
                                </div>
                            </MudTd>
                            <MudTd DataLabel="Currency" Class="@rowClass" @onclick="@(() => ToggleDesktopHolding(context.Symbol))" style="cursor: pointer;">
                                <span class="currency-chip">@context.Currency</span>
                            </MudTd>
                            <MudTd DataLabel="Share Price" Class="@($"{rowClass} text-right")" @onclick="@(() => ToggleDesktopHolding(context.Symbol))" style="cursor: pointer;">
                                <MudText Typo="Typo.body2" Class="numeric-text">@context.SharePrice.ToString("C")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Total Shares" Class="@($"{rowClass} text-right")" @onclick="@(() => ToggleDesktopHolding(context.Symbol))" style="cursor: pointer;">
                                <MudText Typo="Typo.body2" Class="numeric-text">@context.TotalShares</MudText>
                            </MudTd>
                            <MudTd DataLabel="Total Value" Class="@($"{rowClass} text-right")" @onclick="@(() => ToggleDesktopHolding(context.Symbol))" style="cursor: pointer;">
                                <MudText Typo="Typo.body2" Class="fw-semibold numeric-text">@context.TotalValue.ToString("C")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Total Return" Class="@($"{rowClass} text-right")" @onclick="@(() => ToggleDesktopHolding(context.Symbol))" style="cursor: pointer;">
                                <MudText Typo="Typo.body2" Color="@(context.TotalReturn >= 0 ? Color.Success : Color.Error)" Class="fw-semibold numeric-text"
                                         aria-label="@($"Total return {(context.TotalReturn >= 0 ? "gain" : "loss")} {context.TotalReturn.ToString("C")}")">
                                    @(context.TotalReturn >= 0 ? "+" : "")@context.TotalReturn.ToString("C")
                                </MudText>
                            </MudTd>
                            <MudTd DataLabel="Avg Return %" Class="@($"{rowClass} text-right")" @onclick="@(() => ToggleDesktopHolding(context.Symbol))" style="cursor: pointer;">
                                <span class="@(context.AverageReturnPercentage >= 0 ? "port-dashboard-return-badge-success" : "port-dashboard-return-badge-error")"
                                      aria-label="@($"Average return percentage {(context.AverageReturnPercentage >= 0 ? "gain" : "loss")} {Math.Abs(context.AverageReturnPercentage).ToString("F2")} percent")">
                                    @(context.AverageReturnPercentage >= 0 ? "▲" : "▼") @Math.Abs(context.AverageReturnPercentage).ToString("F2")%
                                </span>
                            </MudTd>
                            <MudTd DataLabel="Brokerages" Class="@rowClass" @onclick="@(() => ToggleDesktopHolding(context.Symbol))" style="cursor: pointer;">
                                <div class="d-flex align-center gap-2">
                                    @foreach (var brokerageType in context.BrokerageTypes)
                                    {
                                        <img src="@GetBrokerageIcon(brokerageType)" 
                                             alt="@GetBrokerageName(brokerageType)" 
                                             class="brokerage-logo-img" 
                                             title="@GetBrokerageName(brokerageType)" />
                                    }
                                </div>
                            </MudTd>
                        </RowTemplate>
                        <ChildRowContent>
                            @{
                                var currentSymbol = context.Symbol;
                                var isCurrentExpanded = _expandedDesktopHoldings.Contains(currentSymbol);
                            }
                            @if (isCurrentExpanded)
                            {
                                var brokerageDetails = GetHoldings().Where(h => h.Symbol == currentSymbol).ToList();
                                <MudTr Class="desktop-expanded-content">
                                    <td colspan="9" class="desktop-expanded-cell">
                                        <div class="desktop-holding-details">
                                            <div class="desktop-details-header">
                                                <MudText Typo="Typo.body2" Class="text-muted">Holdings breakdown by brokerage</MudText>
                                            </div>
                                            <div class="desktop-details-grid">
                                                @foreach (var detail in brokerageDetails)
                                                {
                                                    <div class="desktop-detail-card">
                                                        <div class="desktop-detail-brokerage">
                                                            <img src="@GetBrokerageIcon(detail.BrokerageType)" 
                                                                 alt="@GetBrokerageName(detail.BrokerageType)" 
                                                                 class="desktop-brokerage-icon" />
                                                            <MudText Typo="Typo.body1" Class="fw-bold">@GetBrokerageName(detail.BrokerageType)</MudText>
                                                        </div>
                                                        <div class="desktop-detail-stats">
                                                            <div class="desktop-detail-stat-item">
                                                                <MudText Typo="Typo.caption" Class="text-muted">Shares</MudText>
                                                                <MudText Typo="Typo.body2" Class="fw-semibold">@detail.SharesOwned.ToString("N2")</MudText>
                                                            </div>
                                                            <div class="desktop-detail-stat-item">
                                                                <MudText Typo="Typo.caption" Class="text-muted">Market Value</MudText>
                                                                <MudText Typo="Typo.body2" Class="fw-bold">@detail.InvestmentValue.ToString("C")</MudText>
                                                            </div>
                                                            <div class="desktop-detail-stat-item">
                                                                <MudText Typo="Typo.caption" Class="text-muted">Daily Return</MudText>
                                                                <MudText Typo="Typo.body2" Color="@(detail.DailyReturn >= 0 ? Color.Success : Color.Error)" Class="fw-semibold">
                                                                    @(detail.DailyReturn >= 0 ? "+" : "")@detail.DailyReturn.ToString("C")
                                                                </MudText>
                                                            </div>
                                                            <div class="desktop-detail-stat-item">
                                                                <MudText Typo="Typo.caption" Class="text-muted">Return %</MudText>
                                                                <span class="@(detail.DailyReturnPercentage >= 0 ? "desktop-return-badge-success" : "desktop-return-badge-error")">
                                                                    @(detail.DailyReturnPercentage >= 0 ? "▲" : "▼") @Math.Abs(detail.DailyReturnPercentage).ToString("F2")%
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                </MudTr>
                            }
                        </ChildRowContent>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </div>

    <!-- Mobile Layout -->
    <div class="d-block d-md-none mobile-portfolio-layout">
        <!-- Daily Return Card -->
        <MudCard Class="mobile-return-card mb-3" Elevation="0">
            <MudCardContent>
                <div class="d-flex justify-space-between align-start mb-2">
                    <div class="d-flex align-center gap-2">
                        <MudText Typo="Typo.caption" Class="mobile-return-label">DAILY RETURN</MudText>
                        <span class="mobile-currency-badge">@GetPortfolioCurrency()</span>
                    </div>
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                                   Color="Color.Primary" 
                                   Size="Size.Small"
                                   OnClick="@RefreshPortfolio"
                                   Class="mobile-refresh-button" />
                </div>
                <div class="d-flex justify-space-between align-start">
                    <div>
                        <MudText Typo="Typo.h5" Class="mobile-return-value">@GetDailyReturn().ToString("C")</MudText>
                        <div class="mobile-return-percentage @(GetDailyReturnPercentage() >= 0 ? "positive" : "negative")">
                            <MudIcon Icon="@(GetDailyReturnPercentage() >= 0 ? Icons.Material.Filled.ArrowDropUp : Icons.Material.Filled.ArrowDropDown)" Size="Size.Small" />
                            <MudText Typo="Typo.body2" Class="fw-bold">@(GetDailyReturnPercentage() >= 0 ? "+" : "")@GetDailyReturnPercentage().ToString("F2")% Today</MudText>
                        </div>
                    </div>
                </div>
            </MudCardContent>
        </MudCard>

        <!-- Active Holdings Section -->
        <div class="mobile-holdings-header">
            <MudText Typo="Typo.h6" Class="fw-bold">Active Holdings</MudText>
        </div>

        <!-- Condensed Holdings List -->
        <div class="mobile-holdings-list">
            @foreach (var holding in GetAggregatedHoldings())
            {
                var isExpanded = _expandedMobileHoldings.Contains(holding.Symbol);
                var cardClass = $"mobile-holding-card mb-2 {(isExpanded ? "expanded" : "")}";
                <MudCard Class="@cardClass" Elevation="0">
                    <MudCardContent Class="pa-3">
                        <div class="d-flex justify-space-between align-center" @onclick="@(() => ToggleMobileHolding(holding.Symbol))" style="cursor: pointer;">
                            <div class="d-flex align-center gap-3">
                                <MudAvatar Color="Color.Primary" Size="Size.Medium" Class="mobile-holding-avatar">
                                    @GetSymbolAvatarText(holding.Symbol)
                                </MudAvatar>
                                <div>
                                    <div class="d-flex align-center gap-2 mb-1">
                                        <MudText Typo="Typo.body1" Class="fw-bold mb-0">@holding.Symbol</MudText>
                                        <div class="d-flex gap-1">
                                            @foreach (var brokerageType in holding.BrokerageTypes)
                                            {
                                                <img src="@GetBrokerageIcon(brokerageType)" 
                                                     alt="@GetBrokerageName(brokerageType)" 
                                                     class="mobile-brokerage-icon" 
                                                     title="@GetBrokerageName(brokerageType)" />
                                            }
                                        </div>
                                    </div>
                                    <MudText Typo="Typo.caption" Class="text-muted">@holding.Name</MudText>
                                </div>
                            </div>
                            <div class="text-right d-flex align-center gap-2">
                                <div>
                                    <MudText Typo="Typo.body1" Class="fw-bold mb-0">@holding.TotalValue.ToString("C")</MudText>
                                    <div class="mobile-holding-return @(holding.AverageReturnPercentage >= 0 ? "positive" : "negative")">
                                        <MudIcon Icon="@(holding.AverageReturnPercentage >= 0 ? Icons.Material.Filled.ArrowDropUp : Icons.Material.Filled.ArrowDropDown)" Size="Size.Small" />
                                        <MudText Typo="Typo.caption" Class="fw-bold">@(holding.AverageReturnPercentage >= 0 ? "+" : "")@holding.AverageReturnPercentage.ToString("F2")%</MudText>
                                    </div>
                                </div>
                                <MudIcon Icon="@(isExpanded ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" Size="Size.Small" Class="text-muted" />
                            </div>
                        </div>
                        
                        @if (isExpanded)
                        {
                            <div class="mobile-holding-details mt-3 pt-3">
                                @foreach (var detail in GetHoldings().Where(h => h.Symbol == holding.Symbol))
                                {
                                    <div class="mobile-holding-detail-row mb-2 pb-2">
                                        <div class="d-flex justify-space-between align-center mb-1">
                                            <div class="d-flex align-center gap-2">
                                                <img src="@GetBrokerageIcon(detail.BrokerageType)" 
                                                     alt="@GetBrokerageName(detail.BrokerageType)"
                                                     class="mobile-brokerage-icon" />
                                                <MudText Typo="Typo.body2" Class="fw-semibold">@GetBrokerageName(detail.BrokerageType)</MudText>
                                            </div>
                                            <MudText Typo="Typo.body2" Class="fw-bold">@detail.InvestmentValue.ToString("C")</MudText>
                                        </div>
                                        <div class="mobile-detail-stats">
                                            <div class="mobile-detail-stat">
                                                <MudText Typo="Typo.caption" Class="text-muted">Shares</MudText>
                                                <MudText Typo="Typo.caption" Class="fw-semibold">@detail.SharesOwned.ToString("N2")</MudText>
                                            </div>
                                            <div class="mobile-detail-stat">
                                                <MudText Typo="Typo.caption" Class="text-muted">Price</MudText>
                                                <MudText Typo="Typo.caption" Class="fw-semibold">@detail.SharePrice.ToString("C")</MudText>
                                            </div>
                                            <div class="mobile-detail-stat">
                                                <MudText Typo="Typo.caption" Class="text-muted">Return</MudText>
                                                @{
                                                    var returnClass = $"fw-semibold {(detail.DailyReturnPercentage >= 0 ? "text-success" : "text-danger")}";
                                                }
                                                <MudText Typo="Typo.caption" Class="@returnClass">
                                                    @(detail.DailyReturnPercentage >= 0 ? "+" : "")@detail.DailyReturnPercentage.ToString("F2")%
                                                </MudText>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            }
        </div>
    </div>
}
