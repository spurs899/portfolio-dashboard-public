@using MudBlazor
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.SignalR.Client
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IConfiguration Configuration
@implements IAsyncDisposable

<MudDialog>
    <DialogContent>
        @if (_demoMode)
        {
            <MudAlert Severity="Severity.Info" Class="mb-3" Dense="true">
                <strong>Demo Mode:</strong> IBKR authentication is not available in demo mode
            </MudAlert>
        }
        
        <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
            @if (_authStep == AuthStep.Input)
            {
                <MudTextField @bind-Value="_username" 
                              Label="IBKR Username" 
                              Variant="Variant.Outlined" 
                              Class="mb-3"
                              OnKeyDown="HandleKeyDown"
                              Required="true"
                              RequiredError="Username is required"
                              Validation="@(new Func<string, string?>(ValidateUsername))"
                              Immediate="true"
                              Disabled="@_demoMode" />
                              
                <MudTextField @bind-Value="_password" 
                              Label="Password" 
                              Variant="Variant.Outlined" 
                              InputType="InputType.Password" 
                              Class="mb-3"
                              OnKeyDown="HandleKeyDown"
                              Required="true"
                              RequiredError="Password is required"
                              Validation="@(new Func<string, string?>(ValidatePassword))"
                              Immediate="true"
                              Disabled="@_demoMode" />
            }
            
            @if (_authStep == AuthStep.ShowingQR)
            {
                <MudPaper Class="pa-4" Elevation="0">
                    <MudText Typo="Typo.h6" Class="mb-3" Align="Align.Center">
                        Scan QR Code with IBKR Mobile
                    </MudText>
                    
                    @if (!string.IsNullOrEmpty(_qrCodeBase64))
                    {
                        <div style="text-align: center; margin-bottom: 16px;">
                            <img src="data:image/png;base64,@_qrCodeBase64" 
                                 alt="IBKR QR Code" 
                                 style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />
                        </div>
                    }
                    else
                    {
                        <div style="text-align: center; padding: 40px;">
                            <MudProgressCircular Size="Size.Large" Indeterminate="true" />
                            <MudText Typo="Typo.body2" Class="mt-2">Loading QR code...</MudText>
                        </div>
                    }
                    
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mt-3">
                        <MudText Typo="Typo.body2">
                            <strong>Steps:</strong>
                            <ol style="margin: 8px 0; padding-left: 20px;">
                                <li>Open IBKR Mobile app on your phone</li>
                                <li>Go to More → Settings → Authenticate</li>
                                <li>Scan the QR code above</li>
                            </ol>
                        </MudText>
                    </MudAlert>
                    
                    <MudProgressLinear Indeterminate="true" Class="mt-3" />
                </MudPaper>
            }
        </MudForm>

        @if (!string.IsNullOrEmpty(_statusMessage))
        {
            <MudText Typo="Typo.caption" Align="Align.Center" Class="mt-2" Color="Color.Secondary">
                @_statusMessage
            </MudText>
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mt-3">@_errorMessage</MudAlert>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        @if (_authStep == AuthStep.Input)
        {
            <MudButton Color="Color.Primary" 
                       Variant="Variant.Filled" 
                       OnClick="StartAuthentication" 
                       Disabled="@(_isLoading || !_isFormValid || _demoMode)">
                @if (_isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Connecting...</span>
                }
                else
                {
                    <span>Connect</span>
                }
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public EventCallback<string> OnLoginSuccess { get; set; }

    private enum AuthStep { Input, ShowingQR, Success }

    private HubConnection? _hubConnection;
    private MudForm? _form;
    private bool _isFormValid;
    private bool _demoMode;
    private string _username = "";
    private string _password = "";
    private AuthStep _authStep = AuthStep.Input;
    private bool _isLoading = false;
    private string _qrCodeBase64 = "";
    private string _statusMessage = "";
    private string _errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        _demoMode = Configuration.GetValue<bool>("DemoMode");

        if (!_demoMode)
        {
            // Get the API base URL from HttpClient configuration
            var apiBaseUrl = Http.BaseAddress?.ToString().TrimEnd('/') ?? "https://localhost:7262";
            
            // Create SignalR connection to API server
            _hubConnection = new HubConnectionBuilder()
                .WithUrl($"{apiBaseUrl}/hubs/ibkrauth")
                .WithAutomaticReconnect()
                .Build();

            // Listen for QR code images
            _hubConnection.On<string>("ReceiveQRCode", (base64Image) =>
            {
                _qrCodeBase64 = base64Image;
                _authStep = AuthStep.ShowingQR;
                InvokeAsync(StateHasChanged);
            });

            // Listen for auth status updates
            _hubConnection.On<string>("ReceiveAuthStatus", (message) =>
            {
                _statusMessage = message;
                InvokeAsync(StateHasChanged);
            });

            try
            {
                await _hubConnection.StartAsync();
            }
            catch (Exception ex)
            {
                _errorMessage = $"Failed to connect to SignalR: {ex.Message}";
            }
        }
    }

    private string? ValidateUsername(string username)
    {
        if (string.IsNullOrWhiteSpace(username))
            return "Username is required";
        
        if (username.Length < 3)
            return "Username must be at least 3 characters";
        
        return null;
    }

    private string? ValidatePassword(string password)
    {
        if (string.IsNullOrWhiteSpace(password))
            return "Password is required";
        
        if (password.Length < 6)
            return "Password must be at least 6 characters";
        
        return null;
    }

    private async Task StartAuthentication()
    {
        if (_demoMode)
        {
            Snackbar.Add("IBKR authentication is not available in demo mode", Severity.Warning);
            return;
        }

        if (_form == null || _hubConnection == null)
            return;

        await _form.Validate();
        
        if (!_isFormValid)
            return;

        _isLoading = true;
        _errorMessage = "";
        _statusMessage = "Starting authentication...";
        
        try
        {
            var response = await Http.PostAsJsonAsync("/api/ibkrsession/authenticate", new
            {
                username = _username,
                password = _password,
                connectionId = _hubConnection.ConnectionId
            });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AuthResult>();
                
                if (result?.Success == true)
                {
                    _authStep = AuthStep.Success;
                    Snackbar.Add($"Connected to IBKR! Captured {result.CookieCount} session cookies.", Severity.Success);
                    await OnLoginSuccess.InvokeAsync(_username);
                    MudDialog.Close(DialogResult.Ok(_username));
                }
                else
                {
                    _errorMessage = result?.Message ?? "Authentication failed";
                    _authStep = AuthStep.Input;
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                _errorMessage = $"Server error: {response.StatusCode} - {errorContent}";
                _authStep = AuthStep.Input;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
            _authStep = AuthStep.Input;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !_isLoading && _isFormValid && _authStep == AuthStep.Input)
        {
            await StartAuthentication();
        }
    }

    private void Cancel() => MudDialog.Cancel();

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private class AuthResult
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public int CookieCount { get; set; }
    }
}
